# linux 网络命令调研

------

# mtr

## **简介**

**mtr 全称是 mytraceroute**，是一个集大成的工具，它集成了 ping、 traceroute、 nslookup 的功能，诊断网络问题非常方便。

mtr 有个好处就是能够 **实时刷新** 数据，比如 mtr-n [www.baidu.com](http://www.baidu.com) 可以看到，从本地到百度经过的所有路由，并显示每个路由间的丢包率、响应时间等。

### 常用参数

```
mtr -r 不会刷新，一次性打印 10个包的统计结果 mtr -s 用来指定ping数据包的大小 mtr -n no-dns不对IP地址做域名反解析 mtr -a 来设置发送数据包的IP地址，这个用于主机有多个IP时。 mtr -i 使用这个参数来设置ICMP返回之间的要求默认是1秒 mtr -c 指定发送多少个数据包 mtr -4 IPv4 mtr -6 IPv6
```

例: 

mtr -c 5 -s 10 -n -r [www.baidu.com](http://www.baidu.com)

-c 5 :每次发送5个包

-s 10: 每包大小10个字节

-n :no-dns不对IP地址做域名反解析

-r : 不会刷新，一次性打印



### 注：icmp网络限速问题

CPU安全保护机制对ICMP报文的处理包括两个层面：一是软件处理层面的速率限制；二是报文上送CPU的速率限制。
\1. 软件处理层面的速率限制

即icmp rate-limit 命令实现的功能，缺省每个GE接口的ICMP报文速率限制阈值为20pps，整机ICMP报文速率限制为100pps。当某个接口每秒钟上送的ICMP报文超出配置的阈值后，会自动下发ACL。该ACL会将目的MAC为本机的ICMP报文全部丢弃，限制2分钟后恢复，当再次检测到阈值时将重新下发ACL抑制，如此循环。可以通过执行undo icmp rate-limit 命令取消此限制。

\2. 报文上送CPU的速率限制

ICMP报文上送CPU的速率上限为128Kbps。假设按照报文1024字节计算，1s内只能有16个报文上送到CPU，即最快62.5ms发一个包，大于这个速率就会存在丢包。假设按照报文64字节计算1s内可以有256个报文上送CPU，即最快可以4ms发一个包。



## 报文解析

![胡硕 > linux 网络命令调研 > image2020-10-17_10-29-25.png](http://km.vivo.xyz/download/attachments/273414165/image2020-10-17_10-29-25.png?version=1&modificationDate=1602901830000&api=v2)

第一列:显示的是IP地址或本机域名，这点和traceroute很像

第二列: Loss%到达此节点的数据包丢包率，显示的每个对应IP的丢包率。

第三列:snt:100设置发送数据包的数量，默认值是10 通过参数 -c来自定义数量。

第四列:last显示的最近一次的返回时延

第五列:Avg平均值这个应该是发送ping包的平均时延

第六列:Best最好或者说时延最低的

第七列:Wrst最差或者说时延最大的

第八列:StDev是标准偏差



当没有其他路线信息时会出现问号。



# traceroute

## 简介

**traceroute命令**用于追踪数据包在网络上的传输时的全部路径，它默认发送的数据包大小是40字节（实际使用应该是60）。

通过traceroute我们可以知道信息从你的计算机到互联网另一端的主机是走的什么路径。当然每次数据包由某一同样的出发点（source）到达某一同样的目的地(destination)走的路径可能会不一样，但基本上来说大部分时候所走的路由是相同的。

traceroute通过发送小的数据包到目的设备直到其返回，来测量其需要多长时间。一条路径上的每个设备traceroute要测3次。输出结果中包括每次测试的时间(ms)和设备的名称（如有的话）及其[ip](http://man.linuxde.net/ip)地址。

### 常用参数

```
-d：使用Socket层级的排错功能； -f<存活数值>：设置第一个检测数据包的存活数值TTL的大小； -F：设置勿离断位； -g<网关>：设置来源路由网关，最多可设置8个； -i<网络界面>：使用指定的网络界面送出数据包； -I：使用ICMP回应取代UDP资料信息； -m<存活数值>：设置检测数据包的最大存活数值TTL的大小； -n：直接使用IP地址而非主机名称； -p<通信端口>：设置UDP传输协议的通信端口； -r：忽略普通的Routing Table，直接将数据包送到远端主机上。 -s<来源地址>：设置本地主机送出数据包的IP地址； -t<服务类型>：设置检测数据包的TOS数值； -v：详细显示指令的执行过程； -w<超时秒数>：设置等待远端主机回报的时间； -x：开启或关闭数据包的正确性检验。
```

例：

traceroute -q 4 [-n] -m 10 [www.baidu.com](http://www.baidu.com) 30

-q 4 : 4个数据包，用来确保足够ip样本

-m 10：最多10跳，（避免循环路由情况）

30:包大小

### 报文解析

![胡硕 > linux 网络命令调研 > image2020-10-17_12-3-50.png](http://km.vivo.xyz/download/attachments/273414165/image2020-10-17_12-3-50.png?version=1&modificationDate=1602907494000&api=v2)

### 底层实现原理

https://www.jianshu.com/p/75a5822d0eec

![胡硕 > linux 网络命令调研 > image2020-10-17_14-45-37.png](http://km.vivo.xyz/download/attachments/273414165/image2020-10-17_14-45-37.png?version=1&modificationDate=1602917203000&api=v2)



- 客户端发送一个TTL为1的**ICMP请求回显**数据包，在第一跳的时候超时并返回一个ICMP超时数据包，得到第一跳的地址。
- 客户端发送一个TTL为2的ICMP请求回显数据包，得到第二跳的地址。
- 客户端发送一个TTL为3的ICMP请求回显数据包，到达目标主机，目标主机返回一个**ICMP回显应答**，traceroute结束。



有些路由器会隐藏的自己的位置，不让ICMP Timeout的消息通过，结果就是在那一跳上始终会显示星号，此外服务器也可以伪造traceroute路径的，不过一般应用服务器也没有理由这么做，所以Traceroute的结果还是能够为网络分析提供一些参考的。



# PING

## 简介

```
ping [-dfnqrRv][-c<完成次数>][-i<间隔秒数>][-I<网络界面>][-l<前置载入>][-p<范本样式>][-s<数据包大小>][-t<存活数值>][主机名称或IP地址]
-d 使用Socket的SO_DEBUG功能。 -c<完成次数> 设置完成要求回应的次数。 -f 极限检测。 -i<间隔秒数> 指定收发信息的间隔时间。 -I<网络界面> 使用指定的网络接口送出数据包。 -l<前置载入> 设置在送出要求信息之前，先行发出的数据包。 -n 只输出数值。 -p<范本样式> 设置填满数据包的范本样式。 -q 不显示指令执行过程，开头和结尾的相关信息除外。 -r 忽略普通的Routing Table，直接将数据包送到远端主机上。 -R 记录路由过程。 -s<数据包大小> 设置数据包的大小。 -t<存活数值> 设置存活数值TTL的大小。 -v 详细显示指令的执行过程。
```